# 环境配置说明

## 配置文件说明

MaiMaiNotePad Django Backend 使用 `backend/conf/env.py` 文件管理所有配置。

### 配置文件位置
- **主配置文件**：`backend/conf/env.py`
- **Django设置**：`backend/application/settings.py` (通过 `from conf.env import *` 导入配置)

### 配置优先级
```
环境变量 > conf/env.py 中的默认值
```

## 配置项说明

### 数据库配置

在 `conf/env.py` 中配置：

```python
# PostgreSQL（推荐）
DATABASE_ENGINE = "django.db.backends.postgresql"
DATABASE_NAME = 'mai_notebook'
DATABASE_HOST = '127.0.0.1'
DATABASE_PORT = 5432
DATABASE_USER = "mai_notebook"
DATABASE_PASSWORD = 'your_password_here'

# 表前缀
TABLE_PREFIX = "mainotebook_"
```

### Redis 配置

```python
REDIS_DB = 1
CELERY_BROKER_DB = 3
REDIS_PASSWORD = 'your_redis_password'
REDIS_HOST = '127.0.0.1'
REDIS_URL = f'redis://:{REDIS_PASSWORD}@{REDIS_HOST}:6379'
```

### 应用配置

```python
DEBUG = True                    # 调试模式（生产环境设为 False）
ALLOWED_HOSTS = ["*"]          # 允许的主机（生产环境应指定具体域名）
```

**注意**：`SECRET_KEY` 在 `application/settings.py` 中配置。

### 功能开关

```python
# 启动登录详细概略获取（需要外部 API）
ENABLE_LOGIN_ANALYSIS_LOG = False

# 登录接口是否需要验证码认证
LOGIN_NO_CAPTCHA_AUTH = True
```

### AI 内容审核配置

```python
# 硅基流动 API Key（用于 AI 内容审核）
# 获取地址: https://cloud.siliconflow.cn/
# 
# 配置方式（优先级从高到低）：
# 1. 环境变量: export SILICONFLOW_API_KEY=your_key
# 2. 直接在 conf/env.py 中配置
SILICONFLOW_API_KEY = os.getenv('SILICONFLOW_API_KEY', "your_default_key_here")
```

**说明**：
- AI 内容审核功能需要配置此 API Key
- 如果不配置，审核服务将无法启动
- 可以在硅基流动官网免费注册获取 API Key
- 支持通过环境变量覆盖默认配置

## 配置方式

### 方式1：直接修改 `conf/env.py`（推荐用于开发环境）

```python
# 编辑 backend/conf/env.py
SILICONFLOW_API_KEY = "sk-your-actual-api-key-here"
```

### 方式2：使用环境变量（推荐用于生产环境）

```bash
# 临时设置（当前会话）
export SILICONFLOW_API_KEY=sk-your-actual-api-key-here

# 永久设置（添加到 ~/.bashrc 或 ~/.zshrc）
echo 'export SILICONFLOW_API_KEY=sk-your-actual-api-key-here' >> ~/.bashrc
source ~/.bashrc
```

### 方式3：使用 `.env` 文件（可选）

如果需要使用 `.env` 文件，可以安装 `python-dotenv`：

```bash
pip install python-dotenv
```

然后在 `conf/env.py` 开头添加：

```python
from dotenv import load_dotenv
load_dotenv()  # 加载 .env 文件
```

## 最佳实践

### 开发环境
1. 直接在 `conf/env.py` 中配置所有参数
2. 敏感信息（如 API Key）可以使用环境变量覆盖

### 生产环境
1. **必须**修改 `SECRET_KEY`（在 `application/settings.py` 中）
2. **必须**设置 `DEBUG=False`
3. **必须**指定具体的 `ALLOWED_HOSTS`
4. **必须**使用强密码保护数据库和 Redis
5. **建议**使用环境变量而不是硬编码敏感信息

## 示例：生产环境配置

### 修改 `conf/env.py`：

```python
DEBUG = False
ALLOWED_HOSTS = ["yourdomain.com", "www.yourdomain.com"]

DATABASE_ENGINE = "django.db.backends.postgresql"
DATABASE_NAME = 'mai_notebook_prod'
DATABASE_HOST = 'your-db-host.com'
DATABASE_PORT = 5432
DATABASE_USER = "mai_notebook_prod"
DATABASE_PASSWORD = 'your-strong-password-here'

REDIS_HOST = 'your-redis-host.com'
REDIS_PASSWORD = 'your-strong-redis-password'

ENABLE_LOGIN_ANALYSIS_LOG = True
LOGIN_NO_CAPTCHA_AUTH = False

# 使用环境变量（更安全）
SILICONFLOW_API_KEY = os.getenv('SILICONFLOW_API_KEY')
```

### 设置环境变量：

```bash
export SILICONFLOW_API_KEY=sk-your-actual-api-key-here
```

## 安全注意事项

1. **永远不要**将包含敏感信息的 `conf/env.py` 提交到公开仓库
2. 生产环境使用环境变量管理敏感信息
3. 定期更换密钥和密码
4. 生产环境使用强密码（至少 32 位随机字符）
5. 限制数据库和 Redis 的网络访问

## 故障排查

### 问题：AI 审核服务无法启动
**错误信息**：`ValueError: 未找到 SILICONFLOW_API_KEY`

**解决方法**：
```bash
# 方法1：在 conf/env.py 中配置
# 编辑 backend/conf/env.py，设置：
SILICONFLOW_API_KEY = "sk-your-api-key-here"

# 方法2：设置环境变量
export SILICONFLOW_API_KEY=sk-your-api-key-here
```

### 问题：数据库连接失败
**原因**：数据库配置不正确

**解决方法**：
1. 检查 `conf/env.py` 中的数据库配置
2. 确认数据库服务已启动
3. 测试数据库连接：
   ```bash
   psql -h 127.0.0.1 -U mai_notebook -d mai_notebook
   ```

### 问题：Redis 连接失败
**原因**：Redis 配置不正确或服务未启动

**解决方法**：
1. 检查 Redis 服务状态：`redis-cli ping`
2. 检查 Redis 密码配置
3. 确认 Redis 端口未被占用

## 配置检查清单

启动应用前，请确认以下配置：

- [ ] 数据库配置正确（`DATABASE_*` 参数）
- [ ] Redis 配置正确（`REDIS_*` 参数）
- [ ] AI 审核 API Key 已配置（`SILICONFLOW_API_KEY`）
- [ ] 生产环境已设置 `DEBUG=False`
- [ ] 生产环境已配置具体的 `ALLOWED_HOSTS`
- [ ] 生产环境已修改 `SECRET_KEY`
