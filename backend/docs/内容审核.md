# 内容审核

## 概述

内容审核分为两部分：AI 自动审核和人工审核。公开内容提交时自动触发 AI 审核（Celery 异步任务），AI 根据置信度自动决策，不确定的内容留给人工复核。

## AI 自动审核

### 触发时机

- 创建知识库或人设卡时，如果 `is_public=true`，自动调度 `auto_review_task`
- 管理员也可手动触发批量审核

### 审核流程

1. 查找内容对象，确认处于待审核状态
2. 拼接文本字段（name + description + content）进行审核
3. 获取关联的 text/plain 文件，多文件并发审核
4. 大文件自动分段（每段 4000 字符），分段并发审核
5. 聚合所有审核结果（取最高置信度，合并违规类型）
6. 根据置信度执行决策
7. 生成审核报告（ReviewReport）
8. 通知上传者（站内信 + WebSocket 推送）

### 决策阈值

| 置信度范围 | 决策 | 说明 |
|-----------|------|------|
| < 0.5 | auto_approved | 自动通过 |
| 0.5 ~ 0.8 | pending_manual | 待人工复核 |
| > 0.8 | auto_rejected | 自动拒绝 |

### 违规类型

| 类型 | 说明 |
|------|------|
| porn | 色情内容 |
| politics | 涉政内容 |
| abuse | 辱骂内容 |

### 上下文感知审核

AI 审核支持四种文本类型的差异化策略：

- `comment`：评论，关注辱骂和人身攻击，允许正常批评
- `post`：帖子/文章，综合评估整体倾向，对学术内容宽容
- `title`：标题，更严格的审核标准
- `content`：内容正文，全面评估意图，允许引用违规内容用于批判/教育

### Celery 任务

```python
# 单条审核
auto_review_task.delay(str(content_id), 'persona')  # 或 'knowledge'

# 批量审核
batch_auto_review_task.delay(content_ids, 'persona')
```

任务配置：最多重试 3 次，间隔 60 秒。

### AI 审核 API 配置

使用硅基流动的 Qwen/Qwen2.5-7B-Instruct 模型，API Key 在 `conf/env.py` 中配置：

```python
SILICONFLOW_API_KEY = os.getenv('SILICONFLOW_API_KEY', 'your_key_here')
```

### 审核检测接口

```
POST /api/content/moderation/check/
```

请求体：`{"text": "待审核文本", "text_type": "comment"}`

```
GET /api/content/moderation/health/
```

健康检查接口。

## 人工审核

### API 端点

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/content/review/pending/` | 待审核列表 | 审核员+ |
| GET | `/api/content/review/history/` | 审核历史 | 审核员+ |
| GET | `/api/content/review/stats/` | 审核统计 | 审核员+ |
| POST | `/api/content/review/{id}/approve/` | 批准内容 | 审核员+ |
| POST | `/api/content/review/{id}/reject/` | 拒绝内容 | 审核员+ |
| POST | `/api/content/review/{id}/return/` | 退回内容 | 审核员+ |

### 审核通知

审核完成后通过 `ReviewNotificationService` 发送站内信和 WebSocket 推送通知上传者。待人工复核的内容不发送通知。

## 审核报告

每次 AI 审核完成后生成 `ReviewReport`，包含：

- 审核决策（auto_approved / auto_rejected / pending_manual）
- 最终置信度
- 违规类型汇总
- 各审核部分的详细结果（文本字段、各文件、分段详情）

报告支持渲染为可读文本格式（`to_readable_text()`），用于站内信展示。

## 相关文件

- AI 审核服务：`mainotebook/content/services/auto_review_service.py`
- 内容审核 API：`mainotebook/content/services/moderation_service.py`
- 人工审核服务：`mainotebook/content/services/review_service.py`
- 审核通知：`mainotebook/content/services/review_notification.py`
- Celery 任务：`mainotebook/content/tasks.py`
- 审核视图：`mainotebook/content/views/review.py`
- AI 审核视图：`mainotebook/content/views/moderation.py`
