# FastAPI 数据模型迁移至 Django 文档

## 概述

本文档记录了将 MaiMaiNotePad-BackEnd 项目（FastAPI + SQLAlchemy）的数据模型迁移到新的 Django 项目的完整过程。迁移涉及 12 个核心数据模型，采用"复用优先"原则，充分利用现有 Django 项目中的用户模型。

## 迁移范围

### 复用的模型
- **Users**：扩展现有用户模型，添加账户安全、禁言管理等字段
- **MessageCenter**：复用现有消息中心（未修改）
- **FileList**：复用现有文件管理（未修改）

### 新建的模型
1. **KnowledgeBase**：知识库主表
2. **KnowledgeBaseFile**：知识库文件关联表
3. **PersonaCard**：人设卡主表
4. **PersonaCardFile**：人设卡文件关联表
5. **Comment**：评论系统
6. **CommentReaction**：评论反应（点赞/点踩）
7. **StarRecord**：收藏记录
8. **EmailVerification**：邮箱验证
9. **UploadRecord**：上传记录
10. **DownloadRecord**：下载记录

## 迁移过程

### 阶段 1：创建应用结构

创建了新的 Django 应用 `mainotebook.content` 用于存放迁移后的模型：

```bash
cd backend
python manage.py startapp content mainotebook/content
```

应用结构：
```
mainotebook/content/
├── __init__.py
├── models.py          # 所有新模型定义
├── admin.py           # Django Admin 配置
├── apps.py
├── views.py
├── urls.py
└── migrations/        # 数据库迁移文件
    ├── __init__.py
    └── 0001_initial.py
```

### 阶段 2：扩展 Users 模型

在 `mainotebook/system/models.py` 的 `Users` 模型中添加了以下字段：

#### 账户安全字段
- `locked_until`：账户锁定截止时间
- `last_failed_login`：最后一次登录失败时间

#### 禁言管理字段
- `is_muted`：是否被禁言
- `muted_until`：禁言截止时间
- `ban_reason`：封禁原因
- `mute_reason`：禁言原因

#### 其他扩展字段
- `avatar_updated_at`：头像更新时间
- `password_version`：密码版本号
- `is_moderator`：是否为版主
- `is_super_admin`：是否为超级管理员

### 阶段 3：创建新模型

在 `mainotebook/content/models.py` 中创建了 10 个新模型，所有模型都：
- 继承自 `CoreModel`（提供时间戳字段）
- 使用 UUID 作为主键
- 包含完整的中文 docstring
- 设置了适当的索引和约束
- 配置了外键关系和级联行为

### 阶段 4：数据库迁移

生成并执行了数据库迁移：

```bash
# 生成 Users 模型扩展的迁移
python manage.py makemigrations system

# 生成 content 应用的迁移
python manage.py makemigrations content

# 执行迁移
python manage.py migrate
```

迁移文件：
- `mainotebook/system/migrations/0002_users_extensions.py`：Users 模型扩展
- `mainotebook/content/migrations/0001_initial.py`：所有新模型

### 阶段 5：配置 Django Admin

在 `mainotebook/content/admin.py` 中为所有模型配置了 Admin 界面：
- 配置了 `list_display` 显示关键字段
- 配置了 `list_filter` 提供过滤器
- 配置了 `search_fields` 支持搜索
- 配置了 `raw_id_fields` 优化外键选择
- 配置了 `fieldsets` 组织字段显示

### 阶段 6：测试验证

编写并执行了完整的测试套件：

#### 单元测试
- 模型创建、读取、更新、删除（CRUD）测试
- 关系测试（外键、一对多、嵌套关系）
- 唯一约束测试
- 边缘情况测试

#### 属性测试
- 字段类型映射正确性
- 外键关系配置完整性
- 模型元数据完整性
- 代码规范一致性

#### 集成测试
- 知识库完整工作流测试
- 人设卡完整工作流测试

#### 功能验证
- Django Admin CRUD 操作验证
- 外键关系级联行为验证
- 唯一约束有效性验证
- 搜索和过滤功能验证

所有测试均通过，成功率 100%。

## 数据模型设计

### 字段类型映射

从 SQLAlchemy 到 Django ORM 的字段类型映射：

| SQLAlchemy 类型 | Django ORM 类型 | 说明 |
|----------------|----------------|------|
| String(36) [UUID] | UUIDField | 主键使用 UUID |
| String(n) | CharField(max_length=n) | 字符串字段 |
| Text | TextField | 长文本字段 |
| Integer | IntegerField | 整数字段 |
| Boolean | BooleanField | 布尔字段 |
| DateTime | DateTimeField | 日期时间字段 |
| relationship (1:N) | ForeignKey | 外键关系 |
| relationship (1:1) | OneToOneField | 一对一关系 |

### 外键关系配置

所有外键都配置了：
- `on_delete` 参数：
  - `CASCADE`：级联删除（用于从属关系，如文件）
  - `PROTECT`：保护删除（用于重要关系，如用户）
  - `SET_NULL`：设置为空（用于可选关系）
- `related_name` 参数：提供清晰的反向关系访问名称
- `db_constraint=False`：符合现有项目风格

### 索引策略

为以下字段创建了索引：
- 外键字段（自动创建）
- 查询频繁的字段（如 `is_public`、`is_pending`）
- 排序字段（如 `create_datetime`、`star_count`）
- 复合查询字段（如 `target_id` + `target_type`）

### 唯一约束

为以下场景添加了唯一约束：
- 收藏记录：`user` + `target_id` + `target_type`
- 评论反应：`user` + `comment`

## 注意事项

### 数据迁移

本次迁移仅完成了模型结构的迁移，实际数据迁移需要：
1. 从旧数据库导出数据
2. 转换数据格式（UUID、时间戳等）
3. 导入到新数据库
4. 验证数据完整性

### 兼容性考虑

- 所有新字段都设置了默认值或允许为空，确保向后兼容
- 外键使用 `db_constraint=False`，符合现有项目风格
- 表名使用 `table_prefix` 前缀，保持命名一致性

### 性能优化

- 为高频查询字段添加了索引
- 使用 `select_related` 和 `prefetch_related` 优化查询
- 考虑使用缓存减少数据库查询

### 安全性

- 所有用户输入都需要验证
- 敏感操作需要权限检查
- 使用 Django 的内置安全机制防止 SQL 注入

## 使用示例

### 创建知识库

```python
from mainotebook.system.models import Users
from mainotebook.content.models import KnowledgeBase, KnowledgeBaseFile

# 获取用户
user = Users.objects.get(username='testuser')

# 创建知识库
kb = KnowledgeBase.objects.create(
    name='Python 编程指南',
    description='全面的 Python 编程教程',
    uploader=user,
    copyright_owner='张三',
    tags='python,编程,教程',
    version='1.0'
)

# 添加文件
kb_file = KnowledgeBaseFile.objects.create(
    knowledge_base=kb,
    file_name='python_guide.pdf',
    original_name='Python编程指南.pdf',
    file_path='/uploads/knowledge/python_guide.pdf',
    file_type='application/pdf',
    file_size=1024000
)
```

### 创建评论

```python
from mainotebook.content.models import Comment, CommentReaction

# 创建评论
comment = Comment.objects.create(
    user=user,
    target_id=str(kb.id),
    target_type='knowledge',
    content='非常好的教程，推荐！'
)

# 创建回复
reply = Comment.objects.create(
    user=user,
    target_id=str(kb.id),
    target_type='knowledge',
    content='同意，很实用',
    parent=comment
)

# 点赞评论
reaction = CommentReaction.objects.create(
    user=user,
    comment=comment,
    reaction_type='like'
)
```

### 收藏知识库

```python
from mainotebook.content.models import StarRecord

# 创建收藏记录
star = StarRecord.objects.create(
    user=user,
    target_id=str(kb.id),
    target_type='knowledge'
)

# 更新收藏数
kb.star_count += 1
kb.save()
```

### 查询示例

```python
# 查询公开的知识库
public_kbs = KnowledgeBase.objects.filter(
    is_public=True,
    is_pending=False
).order_by('-star_count')

# 查询用户的收藏
user_stars = StarRecord.objects.filter(
    user=user,
    target_type='knowledge'
).select_related('user')

# 查询知识库的评论
kb_comments = Comment.objects.filter(
    target_id=str(kb.id),
    target_type='knowledge',
    is_deleted=False
).select_related('user').prefetch_related('replies')
```

## 维护指南

### 添加新字段

1. 在模型中添加字段定义
2. 生成迁移文件：`python manage.py makemigrations`
3. 执行迁移：`python manage.py migrate`
4. 更新 Admin 配置（如需要）
5. 更新测试用例

### 修改字段

1. 修改模型中的字段定义
2. 生成迁移文件
3. 检查迁移文件，确保数据不会丢失
4. 在测试环境执行迁移
5. 验证数据完整性
6. 在生产环境执行迁移

### 删除字段

1. 确认字段不再被使用
2. 在模型中删除字段定义
3. 生成迁移文件
4. 备份数据库
5. 执行迁移

### 性能监控

定期检查：
- 慢查询日志
- 索引使用情况
- 数据库连接池状态
- 缓存命中率

## 故障排查

### 迁移失败

如果迁移失败：
1. 检查错误消息
2. 回滚到上一个迁移：`python manage.py migrate <app> <migration_name>`
3. 修复问题
4. 重新生成迁移文件
5. 再次执行迁移

### 数据不一致

如果发现数据不一致：
1. 检查外键关系是否正确
2. 检查唯一约束是否生效
3. 检查级联删除是否按预期工作
4. 使用验证脚本检查数据完整性

### 性能问题

如果遇到性能问题：
1. 使用 Django Debug Toolbar 分析查询
2. 检查是否缺少索引
3. 使用 `select_related` 和 `prefetch_related` 优化查询
4. 考虑添加缓存
5. 考虑数据库查询优化

## 相关文档

- [Django 模型文档](https://docs.djangoproject.com/en/stable/topics/db/models/)
- [Django 迁移文档](https://docs.djangoproject.com/en/stable/topics/migrations/)

## 更新历史

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-02-25 | 1.0 | 初始版本，完成模型迁移 |
