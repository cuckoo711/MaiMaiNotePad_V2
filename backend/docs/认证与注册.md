# 认证与注册

## 概述

系统使用 JWT（JSON Web Token）进行用户认证，支持邮箱验证注册流程。认证 header 使用 `JWT` 前缀（非 `Bearer`）。

## 登录

### 接口

```
POST /api/token/
```

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| captcha | string | 否 | 验证码（根据系统配置决定是否必填） |
| captchaKey | string | 否 | 验证码 key |

### 响应

```json
{
  "code": 2000,
  "msg": "请求成功",
  "data": {
    "access": "eyJ...",
    "refresh": "eyJ..."
  }
}
```

### 认证方式

所有需要认证的接口在请求头中携带：

```
Authorization: JWT <access_token>
```

### Token 刷新

```
POST /api/token/refresh/
```

请求体：`{"refresh": "<refresh_token>"}`

## 注册

### 流程

1. 用户提交注册信息（邮箱、用户名、密码）
2. 后端校验唯一性，将注册信息暂存到 Redis（TTL 24 小时）
3. 发送验证邮件（包含验证链接）
4. 用户点击验证链接完成注册
5. 系统自动分配默认部门（注册用户）和角色（普通用户）

### 注册接口

```
POST /api/register/
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 是 | 邮箱地址 |
| username | string | 是 | 用户名（3-30 字符） |
| password | string | 是 | 密码（至少 6 字符） |

频率限制：同一 IP 每小时最多 10 次。

### 邮箱验证接口

```
GET /api/verify-email/?token=<token>
```

### 重发验证邮件

```
POST /api/resend-verification/
```

频率限制：同一 IP 每小时最多 5 次。

## 验证码

```
GET /api/captcha/
```

返回 Base64 编码的验证码图片和 key，是否启用由系统配置 `base.captcha_state` 控制。

## 密码安全

- 密码使用 Django 内置的 `make_password`（PBKDF2）哈希存储
- 兼容 MD5 哈希的旧密码（自动识别）
- 支持账户锁定机制（`locked_until` 字段）
- 密码版本号追踪（`password_version` 字段）

## 相关文件

- 登录视图：`mainotebook/system/views/login.py`
- 注册视图：`mainotebook/system/views/register.py`
- 注册服务：`mainotebook/system/services/registration.py`
- 邮件服务：`mainotebook/system/services/email_service.py`
- 认证后端：`mainotebook/utils/backends.py`
