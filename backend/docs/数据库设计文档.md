# 数据库设计文档

## 概述

本文档描述了 MaiMaiNotePad 项目的数据库设计，包括所有表结构、字段定义、关系和约束。

## 数据库信息

- **数据库类型**：MySQL / PostgreSQL（根据配置）
- **字符集**：UTF-8
- **表前缀**：`dva_`（由 `table_prefix` 配置）

## 表结构

### 用户相关表

#### dva_system_users（用户表）

存储用户基本信息和扩展信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 用户 ID |
| username | VARCHAR(150) | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR(255) | UNIQUE | 邮箱地址 |
| mobile | VARCHAR(11) | UNIQUE | 手机号 |
| avatar | VARCHAR(255) | NULL | 头像路径 |
| name | VARCHAR(40) | NULL | 姓名 |
| gender | INT | NULL | 性别（0:未知, 1:男, 2:女） |
| user_type | INT | NULL | 用户类型 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| locked_until | DATETIME | NULL | 账户锁定截止时间 |
| last_failed_login | DATETIME | NULL | 最后一次登录失败时间 |
| is_muted | BOOLEAN | DEFAULT FALSE | 是否被禁言 |
| muted_until | DATETIME | NULL | 禁言截止时间 |
| ban_reason | TEXT | NULL | 封禁原因 |
| mute_reason | TEXT | NULL | 禁言原因 |
| avatar_updated_at | DATETIME | NULL | 头像更新时间 |
| password_version | INT | DEFAULT 0 | 密码版本号 |
| is_moderator | BOOLEAN | DEFAULT FALSE | 是否为版主 |
| is_super_admin | BOOLEAN | DEFAULT FALSE | 是否为超级管理员 |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_username`：username
- `idx_email`：email
- `idx_mobile`：mobile
- `idx_locked_until`：locked_until
- `idx_is_muted`：is_muted
- `idx_is_moderator`：is_moderator
- `idx_is_super_admin`：is_super_admin

### 内容相关表

#### dva_content_knowledge_base（知识库表）

存储用户上传的知识库内容。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 知识库 ID |
| name | VARCHAR(200) | NOT NULL | 知识库名称 |
| description | TEXT | NOT NULL | 知识库描述 |
| uploader_id | BIGINT | FK(Users), NOT NULL | 上传者 ID |
| copyright_owner | VARCHAR(200) | NULL | 版权所有者 |
| content | TEXT | NULL | 知识库文本内容 |
| tags | TEXT | NULL | 标签（逗号分隔） |
| star_count | INT | DEFAULT 0 | 收藏数 |
| downloads | INT | DEFAULT 0 | 下载次数 |
| base_path | TEXT | DEFAULT '[]' | 基础路径（JSON） |
| is_public | BOOLEAN | DEFAULT FALSE | 是否公开 |
| is_pending | BOOLEAN | DEFAULT TRUE | 是否待审核 |
| rejection_reason | TEXT | NULL | 拒绝原因 |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_uploader`：uploader_id
- `idx_is_public`：is_public
- `idx_is_pending`：is_pending
- `idx_star_count`：star_count
- `idx_create_datetime`：create_datetime
- `idx_update_datetime`：update_datetime

**外键：**
- `uploader_id` → `dva_system_users.id` (PROTECT)

#### dva_content_knowledge_base_file（知识库文件表）

存储知识库关联的文件信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 文件 ID |
| knowledge_base_id | UUID | FK(KnowledgeBase), NOT NULL | 关联知识库 ID |
| file_name | VARCHAR(255) | NOT NULL | 存储的文件名 |
| original_name | VARCHAR(255) | NOT NULL | 原始文件名 |
| file_path | VARCHAR(500) | NOT NULL | 文件存储路径 |
| file_type | VARCHAR(100) | NOT NULL | 文件 MIME 类型 |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_knowledge_base`：knowledge_base_id
- `idx_file_type`：file_type
- `idx_file_size`：file_size
- `idx_create_datetime`：create_datetime
- `idx_update_datetime`：update_datetime

**外键：**
- `knowledge_base_id` → `dva_content_knowledge_base.id` (CASCADE)

#### dva_content_persona_card（人设卡表）

存储用户上传的人设卡内容，结构与知识库表相同。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 人设卡 ID |
| name | VARCHAR(200) | NOT NULL | 人设卡名称 |
| description | TEXT | NOT NULL | 人设卡描述 |
| uploader_id | BIGINT | FK(Users), NOT NULL | 上传者 ID |
| copyright_owner | VARCHAR(200) | NULL | 版权所有者 |
| content | TEXT | NULL | 人设卡文本内容 |
| tags | TEXT | NULL | 标签（逗号分隔） |
| star_count | INT | DEFAULT 0 | 收藏数 |
| downloads | INT | DEFAULT 0 | 下载次数 |
| base_path | TEXT | DEFAULT '[]' | 基础路径（JSON） |
| is_public | BOOLEAN | DEFAULT FALSE | 是否公开 |
| is_pending | BOOLEAN | DEFAULT TRUE | 是否待审核 |
| rejection_reason | TEXT | NULL | 拒绝原因 |
| version | VARCHAR(50) | DEFAULT '1.0' | 版本号 |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：** 与知识库表相同

**外键：**
- `uploader_id` → `dva_system_users.id` (PROTECT)

#### dva_content_persona_card_file（人设卡文件表）

存储人设卡关联的文件信息，结构与知识库文件表相同。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 文件 ID |
| persona_card_id | UUID | FK(PersonaCard), NOT NULL | 关联人设卡 ID |
| file_name | VARCHAR(255) | NOT NULL | 存储的文件名 |
| original_name | VARCHAR(255) | NOT NULL | 原始文件名 |
| file_path | VARCHAR(500) | NOT NULL | 文件存储路径 |
| file_type | VARCHAR(100) | NOT NULL | 文件 MIME 类型 |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：** 与知识库文件表相同

**外键：**
- `persona_card_id` → `dva_content_persona_card.id` (CASCADE)

### 交互相关表

#### dva_content_comment（评论表）

存储用户对知识库和人设卡的评论，支持嵌套回复。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 评论 ID |
| user_id | BIGINT | FK(Users), NOT NULL | 评论用户 ID |
| target_id | VARCHAR(36) | NOT NULL | 目标 ID（UUID 字符串） |
| target_type | VARCHAR(20) | NOT NULL | 目标类型（knowledge/persona） |
| parent_id | UUID | FK(Comment), NULL | 父评论 ID |
| content | TEXT | NOT NULL | 评论内容 |
| is_deleted | BOOLEAN | DEFAULT FALSE | 是否已删除（软删除） |
| like_count | INT | DEFAULT 0 | 点赞数 |
| dislike_count | INT | DEFAULT 0 | 点踩数 |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_target`：(target_id, target_type)
- `idx_user`：user_id
- `idx_parent`：parent_id
- `idx_create_datetime`：create_datetime

**外键：**
- `user_id` → `dva_system_users.id` (PROTECT)
- `parent_id` → `dva_content_comment.id` (CASCADE)

#### dva_content_comment_reaction（评论反应表）

记录用户对评论的点赞或点踩行为。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 反应 ID |
| user_id | BIGINT | FK(Users), NOT NULL | 用户 ID |
| comment_id | UUID | FK(Comment), NOT NULL | 评论 ID |
| reaction_type | VARCHAR(10) | NOT NULL | 反应类型（like/dislike） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_comment`：comment_id

**唯一约束：**
- `unique_user_comment_reaction`：(user_id, comment_id)

**外键：**
- `user_id` → `dva_system_users.id` (CASCADE)
- `comment_id` → `dva_content_comment.id` (CASCADE)

#### dva_content_star_record（收藏记录表）

记录用户对知识库或人设卡的收藏行为。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 收藏 ID |
| user_id | BIGINT | FK(Users), NOT NULL | 用户 ID |
| target_id | VARCHAR(36) | NOT NULL | 目标 ID（UUID 字符串） |
| target_type | VARCHAR(20) | NOT NULL | 目标类型（knowledge/persona） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_user`：user_id
- `idx_target_id`：target_id
- `idx_target_type`：target_type
- `idx_create_datetime`：create_datetime

**唯一约束：**
- `unique_user_target_star`：(user_id, target_id, target_type)

**外键：**
- `user_id` → `dva_system_users.id` (CASCADE)

### 记录相关表

#### dva_content_email_verification（邮箱验证表）

存储邮箱验证码，用于用户注册、找回密码等场景。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 验证 ID |
| email | VARCHAR(255) | NOT NULL | 邮箱地址 |
| code | VARCHAR(10) | NOT NULL | 验证码 |
| is_used | BOOLEAN | DEFAULT FALSE | 是否已使用 |
| expires_at | DATETIME | NOT NULL | 过期时间 |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_email`：email
- `idx_code`：code
- `idx_expires_at`：expires_at

#### dva_content_upload_record（上传记录表）

记录用户的上传行为和审核状态。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 上传记录 ID |
| uploader_id | BIGINT | FK(Users), NOT NULL | 上传者 ID |
| target_id | VARCHAR(36) | NOT NULL | 目标 ID（UUID 字符串） |
| target_type | VARCHAR(20) | NOT NULL | 目标类型（knowledge/persona） |
| name | VARCHAR(200) | NOT NULL | 上传内容名称 |
| description | TEXT | NULL | 上传内容描述 |
| status | VARCHAR(20) | DEFAULT 'pending' | 审核状态（pending/approved/rejected） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_uploader`：uploader_id
- `idx_target_id`：target_id
- `idx_target_type`：target_type
- `idx_status`：status
- `idx_create_datetime`：create_datetime

**外键：**
- `uploader_id` → `dva_system_users.id` (PROTECT)

#### dva_content_download_record（下载记录表）

记录知识库和人设卡的下载行为，用于统计下载次数。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 下载记录 ID |
| target_id | VARCHAR(36) | NOT NULL | 目标 ID（UUID 字符串） |
| target_type | VARCHAR(20) | NOT NULL | 目标类型（knowledge/persona） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_target_id`：target_id
- `idx_target_type`：target_type
- `idx_create_datetime`：create_datetime

#### dva_content_review_report（AI 审核报告表）

存储 AI 自动审核的详细结果，每次审核完成后生成一份报告。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 报告 ID |
| content_id | UUID | NOT NULL | 关联的知识库或人设卡 ID |
| content_type | VARCHAR(20) | NOT NULL | 内容类型（knowledge/persona） |
| content_name | VARCHAR(200) | NOT NULL | 内容名称 |
| decision | VARCHAR(20) | NOT NULL | 审核决策（auto_approved/auto_rejected/pending_manual） |
| final_confidence | FLOAT | NOT NULL | 最终置信度（0~1） |
| violation_types | JSON | DEFAULT [] | 违规类型汇总（如 porn/politics/abuse） |
| report_data | JSON | NOT NULL | 报告详细数据（各审核部分的结构化结果） |
| create_datetime | DATETIME | AUTO_NOW_ADD | 创建时间 |
| update_datetime | DATETIME | AUTO_NOW | 更新时间 |

**索引：**
- `idx_content_id`：content_id
- `idx_content_type`：content_type
- `idx_decision`：decision
- `idx_create_datetime`：create_datetime

## 实体关系图（ER 图）

```
┌─────────────────┐
│     Users       │
│  (用户表)       │
└────────┬────────┘
         │
         │ 1:N (uploader)
         │
    ┌────┴────────────────────────────┐
    │                                 │
    ▼                                 ▼
┌─────────────────┐          ┌─────────────────┐
│ KnowledgeBase   │          │  PersonaCard    │
│  (知识库表)     │          │  (人设卡表)     │
└────────┬────────┘          └────────┬────────┘
         │                            │
         │ 1:N                        │ 1:N
         │                            │
         ▼                            ▼
┌─────────────────┐          ┌─────────────────┐
│KnowledgeBaseFile│          │PersonaCardFile  │
│(知识库文件表)   │          │(人设卡文件表)   │
└─────────────────┘          └─────────────────┘

┌─────────────────┐
│     Users       │
└────────┬────────┘
         │
         │ 1:N (user)
         │
         ▼
┌─────────────────┐
│    Comment      │
│   (评论表)      │
└────────┬────────┘
         │
         │ 1:N (comment)
         │
         ▼
┌─────────────────┐
│CommentReaction  │
│ (评论反应表)    │
└─────────────────┘

┌─────────────────┐
│     Users       │
└────────┬────────┘
         │
         │ 1:N (user)
         │
    ┌────┴────────────────────────────┐
    │                                 │
    ▼                                 ▼
┌─────────────────┐          ┌─────────────────┐
│  StarRecord     │          │  UploadRecord   │
│  (收藏记录表)   │          │  (上传记录表)   │
└─────────────────┘          └─────────────────┘
```

## 关系说明

### 一对多关系

1. **Users → KnowledgeBase**
   - 一个用户可以上传多个知识库
   - 外键：`KnowledgeBase.uploader_id`
   - 级联：PROTECT（保护删除）

2. **Users → PersonaCard**
   - 一个用户可以上传多个人设卡
   - 外键：`PersonaCard.uploader_id`
   - 级联：PROTECT（保护删除）

3. **KnowledgeBase → KnowledgeBaseFile**
   - 一个知识库可以包含多个文件
   - 外键：`KnowledgeBaseFile.knowledge_base_id`
   - 级联：CASCADE（级联删除）

4. **PersonaCard → PersonaCardFile**
   - 一个人设卡可以包含多个文件
   - 外键：`PersonaCardFile.persona_card_id`
   - 级联：CASCADE（级联删除）

5. **Users → Comment**
   - 一个用户可以发表多条评论
   - 外键：`Comment.user_id`
   - 级联：PROTECT（保护删除）

6. **Comment → Comment**（自引用）
   - 一条评论可以有多条回复
   - 外键：`Comment.parent_id`
   - 级联：CASCADE（级联删除）

7. **Comment → CommentReaction**
   - 一条评论可以有多个反应
   - 外键：`CommentReaction.comment_id`
   - 级联：CASCADE（级联删除）

8. **Users → StarRecord**
   - 一个用户可以有多条收藏记录
   - 外键：`StarRecord.user_id`
   - 级联：CASCADE（级联删除）

9. **Users → UploadRecord**
   - 一个用户可以有多条上传记录
   - 外键：`UploadRecord.uploader_id`
   - 级联：PROTECT（保护删除）

### 多态关系

以下表使用 `target_id` + `target_type` 实现多态关系：

1. **Comment**：可以评论知识库或人设卡
2. **StarRecord**：可以收藏知识库或人设卡
3. **UploadRecord**：可以记录知识库或人设卡的上传
4. **DownloadRecord**：可以记录知识库或人设卡的下载

## 数据完整性

### 外键约束

所有外键关系都在应用层面维护（`db_constraint=False`），不在数据库层面创建约束。这是为了：
- 提高性能（避免数据库级别的约束检查）
- 增加灵活性（便于数据迁移和维护）
- 符合现有项目风格

### 唯一约束

以下表有唯一约束：
- `Users`：username, email, mobile
- `CommentReaction`：(user_id, comment_id)
- `StarRecord`：(user_id, target_id, target_type)

### 级联行为

- **CASCADE**：删除父记录时自动删除子记录（用于从属关系）
- **PROTECT**：如果有子记录则不允许删除父记录（用于重要关系）
- **SET_NULL**：删除父记录时将子记录的外键设置为 NULL（未使用）

## 索引策略

### 单字段索引

为以下类型的字段创建索引：
- 外键字段（自动创建）
- 查询频繁的字段（如 `is_public`、`is_pending`）
- 排序字段（如 `create_datetime`、`star_count`）

### 复合索引

为以下场景创建复合索引：
- `Comment`：(target_id, target_type) - 查询特定目标的评论
- `Users`：(user, is_read) - 查询用户的未读消息

## 数据类型说明

### UUID

所有新模型使用 UUID 作为主键：
- 优点：全局唯一、分布式友好、安全性高
- 缺点：占用空间较大、索引性能略低

### 时间戳

所有模型都有 `create_datetime` 和 `update_datetime` 字段：
- `create_datetime`：记录创建时间，自动设置
- `update_datetime`：记录更新时间，自动更新

### 布尔值

布尔字段使用 `BooleanField`：
- 数据库存储：TINYINT(1) (MySQL) 或 BOOLEAN (PostgreSQL)
- Python 值：True/False

### JSON

`base_path` 字段使用 `TextField` 存储 JSON 字符串：
- 未来可以考虑使用 `JSONField`（Django 3.1+）
- 需要在应用层进行 JSON 序列化/反序列化

## 性能优化建议

### 查询优化

1. **使用 select_related**：预加载外键关系
2. **使用 prefetch_related**：预加载多对多关系
3. **使用 only/defer**：只查询需要的字段
4. **使用 iterator**：处理大量数据时避免内存溢出

### 索引优化

1. **定期分析索引使用情况**：删除未使用的索引
2. **监控慢查询**：为慢查询添加索引
3. **避免过度索引**：索引会影响写入性能

### 数据归档

对于历史数据：
1. **定期归档**：将旧数据移到归档表
2. **分区表**：按时间分区（如果数据库支持）
3. **数据清理**：定期清理无用数据

## 备份策略

### 备份频率

- **全量备份**：每天一次
- **增量备份**：每小时一次
- **日志备份**：实时备份

### 备份保留

- **每日备份**：保留 30 天
- **每周备份**：保留 3 个月
- **每月备份**：保留 1 年

## 相关文档

- [数据库迁移文档](./archive/数据库迁移文档.md)
- [迁移注意事项](./archive/迁移注意事项.md)
- [Django 模型文档](https://docs.djangoproject.com/en/stable/topics/db/models/)

## 更新历史

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-02-25 | 1.0 | 初始版本 |
