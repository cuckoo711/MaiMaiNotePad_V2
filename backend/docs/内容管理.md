# 内容管理

## 概述

内容管理模块（`mainotebook.content`）提供知识库和人设卡的完整生命周期管理，包括 CRUD、文件上传/下载、公开/私有状态、审核流程、收藏和评论。

## 知识库

### API 端点

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/content/knowledge/` | 公开知识库列表（已审核） | 公开 |
| POST | `/api/content/knowledge/` | 创建知识库 | 登录 |
| GET | `/api/content/knowledge/{id}/` | 知识库详情 | 公开 |
| PUT | `/api/content/knowledge/{id}/` | 更新知识库 | 创建者 |
| DELETE | `/api/content/knowledge/{id}/` | 删除知识库 | 创建者 |
| GET | `/api/content/knowledge/my/` | 我的知识库列表 | 登录 |
| POST | `/api/content/knowledge/{id}/files/` | 添加文件 | 创建者 |
| GET | `/api/content/knowledge/{id}/files/{fid}/` | 下载文件 | 登录 |
| DELETE | `/api/content/knowledge/{id}/files/{fid}/` | 删除文件 | 创建者 |
| POST | `/api/content/knowledge/{id}/submit/` | 提交审核 | 创建者 |
| POST | `/api/content/knowledge/{id}/star/` | 收藏 | 登录 |
| DELETE | `/api/content/knowledge/{id}/star/` | 取消收藏 | 登录 |

### 列表查询参数

| 参数 | 说明 |
|------|------|
| keyword | 搜索名称或描述 |
| tags | 标签过滤 |
| uploader | 上传者 ID |
| ordering | 排序字段（如 `-create_datetime`、`-star_count`、`name`） |
| page | 页码 |
| limit | 每页数量 |

### 创建参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 名称（用户范围内唯一） |
| description | string | 是 | 描述 |
| copyright_owner | string | 否 | 版权所有者 |
| content | string | 否 | 补充说明（仅创建者可见） |
| tags | string | 否 | 标签（逗号分隔） |
| is_public | boolean | 否 | 是否公开（默认 false） |
| files | File[] | 否 | 上传的文件 |

### 公开/私有与审核

- `is_public=false`：私有内容，`is_pending` 自动设为 `false`，无需审核
- `is_public=true`：公开内容，`is_pending` 保持 `true`，自动触发 AI 审核（Celery 异步任务）
- AI 审核通过后自动批准，不通过则自动拒绝，不确定则留给人工审核

## 人设卡

### API 端点

与知识库结构相同，路径前缀为 `/api/content/persona/`。

### 特殊功能

- 版本号自动解析：创建时如果上传了 `bot_config.toml` 文件，自动从中解析版本号
- 版本号搜索优先级：顶层字段（`version`、`schema_version`、`card_version`）→ `meta`/`card` 子字段 → 深度搜索
- `has_valid_toml` 字段：标识是否包含有效的 bot_config.toml 文件

## 评论系统

### API 端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/content/comments/` | 获取评论列表（树形结构） |
| POST | `/api/content/comments/` | 发表评论 |
| DELETE | `/api/content/comments/{id}/` | 删除评论（软删除） |
| POST | `/api/content/comments/{id}/like/` | 点赞 |
| DELETE | `/api/content/comments/{id}/like/` | 取消点赞 |
| POST | `/api/content/comments/{id}/restore/` | 恢复评论（管理员） |

### 评论参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| target_id | string | 是 | 目标 ID（知识库或人设卡的 UUID） |
| target_type | string | 是 | 目标类型（`knowledge` / `persona`） |
| content | string | 是 | 评论内容 |
| parent | string | 否 | 父评论 ID（用于回复） |
| reply_to | string | 否 | 回复目标评论 ID |

## 收藏系统

收藏接口集成在知识库和人设卡的 ViewSet 中（`star` / `unstar` action）。

用户收藏列表通过 `/api/content/users/stars/` 获取。

## 内容可见性规则

- 列表接口（list）：只返回 `is_public=true` 且 `is_pending=false` 的内容
- 详情接口（retrieve）：管理员/审核员可查看所有，普通用户只能看公开内容和自己的
- `content` 字段（补充说明）：仅创建者可见，非创建者返回 `null`

## 相关文件

- 知识库视图：`mainotebook/content/views/knowledge_base.py`
- 人设卡视图：`mainotebook/content/views/persona_card.py`
- 评论视图：`mainotebook/content/views/comment.py`
- 收藏视图：`mainotebook/content/views/star.py`
- 知识库服务：`mainotebook/content/services/knowledge_base_service.py`
- 人设卡服务：`mainotebook/content/services/persona_card_service.py`
- 评论服务：`mainotebook/content/services/comment_service.py`
- 收藏服务：`mainotebook/content/services/star_service.py`
- 文件服务：`mainotebook/content/services/file_service.py`
- 数据模型：`mainotebook/content/models.py`
- 序列化器：`mainotebook/content/serializers/`
